""" unzip.py
	Version: 1.1

	Extract a zipfile to the directory provided
	It first creates the directory structure to house the files
	then it extracts the files to it.

	Sample usage:
	command line
	unzip.py -p 10 -z c:\testfile.zip -o c:\testoutput

	python class
	import unzip
	un = unzip.unzip()
	un.extract(r'c:\testfile.zip', 'c:\testoutput')
   

	By Doug Tolton
"""

import sys
import zipfile
import os
import os.path

class unzip:
	def __init__(self, verbose = False, percent = 10):
		self.verbose = verbose
		self.percent = percent
		
	
	def extract2(self,file,dir):

		z = zipfile.ZipFile(file)
		z.extractall(dir)
	
	

	   
	def extract(self, file, dir):
		##if not dir.endswith(':') and not os.path.exists(dir):
		##	  os.mkdir(dir)

		zf = zipfile.ZipFile(file, "r")

		# create directory structure to house files
		self._createstructure(file, dir)

		num_files = len(zf.namelist())
		percent = self.percent
		divisions = 100 / percent
		perc = int(num_files / divisions)

		# extract files to directory structure
		for i, name in enumerate(zf.namelist()):

			if self.verbose == True:
				print("Extracting %s" % name)
			elif perc > 0 and (i % perc) == 0 and i > 0:
				complete = int (i / perc) * percent
				print("%s%% complete" % complete)

			if not name.endswith('/'):
				outfile = open(os.path.join(dir, name) , 'wb')
				outfile.write(zf.read(name))
				outfile.flush()
				outfile.close()


	def extract_med(self, file, dir):
		if not dir.endswith(':') and not os.path.exists(dir):
			os.mkdir(dir)

		zf = zipfile.ZipFile(file)

		# create directory structure to house files
		self._createstructure(file, dir)

		num_files = len(zf.namelist())
		percent = self.percent
		divisions = 100 / percent
		perc = int(num_files / divisions)

		# extract files to directory structure
		for i, name in enumerate(zf.namelist()):

			if self.verbose == True:
				print("Extracting %s" % name)
			elif perc > 0 and (i % perc) == 0 and i > 0:
				complete = int (i / perc) * percent
				print("%s%% complete" % complete)

			if not name.endswith('/'):
				outfile = open(os.path.join(dir, name), 'wb')
				outfile.write(zf.read(name))
				outfile.flush()
				outfile.close()

	def get_file_list(self, zip_file):
		zf = zipfile.ZipFile(zip_file)
		return zf.namelist()
	   


	def _createstructure(self, file, dir):
		self._makedirs(self._listdirs(file), dir)


	def _makedirs(self, directories, basedir):
		""" Create any directories that don't currently exist """
		for dir in directories:
			curdir = os.path.join(basedir, dir) 
			if not os.path.exists(curdir):
				os.mkdir(curdir)

	def _listdirs(self, file):
		""" Grabs all the directories in the zip structure
		This is necessary to create the structure before trying
		to extract the file to it. """
		zf = zipfile.ZipFile(file)

		dirs = []

		for name in zf.namelist():
			if name.endswith('/'):
				dirs.append(name)

		dirs.sort()
		return dirs

