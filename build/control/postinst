#!/bin/sh

ARCHIVCZSK='/usr/lib/enigma2/python/Plugins/Extensions/archivCZSK'
TMP='/tmp/archivczsk'

chmod 755 $ARCHIVCZSK/script/*.sh 2>/dev/null

if [ -f $TMP/categories.xml ] ; then
	echo "Found categories.xml, restoring..."
	cp $TMP/categories.xml $ARCHIVCZSK
fi

if [ -d $TMP/data/ ] ; then
	echo "Found DATA, restoring..."
	if [ -d $ARCHIVCZSK/resources/data ]; then
		rm -rf $ARCHIVCZSK/resources/data
	fi
	cp -R $TMP/data $ARCHIVCZSK/resources
fi

if [ -d $TMP/skins/ ] ; then
	echo "Found SKINS, restoring..."
	cp $TMP/skins/* $ARCHIVCZSK/gui/skins
fi

if [ -d $TMP/addons/ ] ; then
	echo "Found official ADDONS, restoring..."
	# remove saved addon.xml file, so it can be updated
	rm -f $TMP/addons/addon.xml

	cp -R $TMP/addons $ARCHIVCZSK/resources/repositories
fi

if [ -d $TMP/repositories/ ] ; then
	find $TMP/repositories -type d -maxdepth 1 -mindepth 1 | while read REPO ; do
		echo "restoring REPOSITORY `basename $REPO` ..."
		cp -R $REPO $ARCHIVCZSK/resources/repositories
	done
fi

touch $ARCHIVCZSK/.first_start

if [ -f ${TMP}/last_version.txt ] ; then
	cat ${TMP}/last_version.txt > $ARCHIVCZSK/.first_start
fi

echo "Removing temp folder..."
rm -rf ${TMP}/

echo "Installation of archivCZSK was successfull, starting script to install dependencies in background ..."

[ -f $ARCHIVCZSK/script/install_dependencies.sh ] && (cd $ARCHIVCZSK/script/ && ./install_dependencies.sh) &

exit 0
